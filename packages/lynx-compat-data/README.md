# `@lynx-js/lynx-compat-data`

The Lynx Compatibility Data ("LCD") project contains machine-readable compatibility data for Lynx technologies, such as Lynx APIs, elements, components, and features across different platforms and versions. Our goal is to document accurate compatibility information for Lynx technologies, enabling developers to create cross-platform compatible applications more easily within the Lynx ecosystem.

## Package contents

There are two types of data in this package:

1. **Platform data**: Data for Lynx platforms e.g. iOS, Android, Web, etc.
2. **(API) Compat data**: Data for different categories of APIs provided by the Lynx platform.

### Platform data

Platform data are defined against [`platform-schema.json`](./schemas/platform-schema.json). See [`platform-schema.md`](./schemas/platform-schema.md) for more details.

#### [`platforms`](./platforms)

Data for Lynx platforms e.g. iOS, Android, Web, etc.

`platforms.json` contains the ids of all platforms. This shall be generated by the build script in the future.

### (API) Compat data

Compat data are defined against [`compat-data-schema.json`](./schemas/compat-data-schema.json). See [`compat-data-schema.md`](./schemas/platform-schema.md) for more details.

Compat data are categorized into different directories (e.g. `elements`, `css`), in which each directory may or may not contains sub-category (e.g. `css/properties`) as children directories if such category is not referenceable as code entity (If it's referenceable, it should be defined as a `*.json` file directly under the category).

Each `*.json` file indicate an API module, defining the root API module (e.g. `lynx`, `<image>`), and a list of identifiers (functions, classes, properties, etc.) under that module (e.g. `lynx.createSelectorQuery`, `<image src>` ).

#### [`elements`](./elements)

Data for Lynx elements e.g. `<view>`, `<text>`, `<image>`, etc.

#### [`css`](./css)

Data for CSS e.g. properties like `background`, `color`, etc.

#### [`lynx-api`](./lynx-api)

Data for Lynx APIs, e.g. `setTimeout`.

#### [`lynx-native-api`](./lynx-api)

Data for Lynx Native APIs, e.g. `LynxView`.

#### [`react`](./react)

Data for ReactLynx framework.

## Usages

### Usages of JSON files

This package contains all the data in its raw JSON format without packaging them into a giant aggregated JSON file, so you can just reference them individually by path:

```ts
// Static import
import testData from '@lynx-js/lynx-compat-data/test/api.json';

// Dynamic import
const testData = await import('@lynx-js/lynx-compat-data/test/api.json');

// If you server them somewhere...
fetch('/path/to/data.json')
  .then((res) => res.json())
  .then((data) => {
    // use the data here
  });
```

### Usages of TypeScript types

Additionally, types are also exported. Types are particularly useful when you want to declare functions to consume data in a type-safe manner:

```ts
// Import specific types
import type { PlatformName } from '@lynx-js/lynx-compat-data';

function mapPlatformNameToName(platform: PlatformName) {
  switch (platform) {
    case 'android':
      return 'Android';
    case 'ios':
      return 'iOS';
    // if you miss some cases, TypeScript will help you out.
  }
}
```

### Type-safety

The json files will be validated using [Avj JSON schema validator](https://ajv.js.org/) against [JSON Schemas](./schemas) prior to release, so you can usually trust their types:

```ts
// Platform data
import type { PlatformStatement } from '@lynx-js/lynx-compat-data';
import iosJson from '@lynx-js/lynx-compat-data/platforms/ios.json';
const ios = iosJson.platforms.ios as PlatformStatement;

// API data
import type { Identifier } from '@lynx-js/lynx-compat-data';
import sTOJson from '@lynx-js/lynx-compat-data/lynx-api/global/setTimeout.json';
const sTO = sTO['lynx-api'].global.setTimeout as Identifier;
```

But to make it more robust, we have also exported utility functions to help you work with the data in a type-safe manner at runtime.

```ts
import { isPlatformStatement } from '@lynx-js/lynx-compat-data';
import iosJson from '@lynx-js/lynx-compat-data/platforms/ios.json';

if (isPlatformStatement(iosJson.platforms.ios)) {
  // ios: PlatformStatement
  ios.type; // safe to access
}
```

A more realistic example of fetching data remotely:

```ts
fetch('https://api.example.com/lynx-compat-data/platforms/ios.json')
  .then((response) => response.json())
  .then((data) => {
    if (isPlatformStatement(data.platforms.ios)) {
      console.log(`iOS platform type: ${data.platforms.ios.type}`);
      console.log(
        `Latest iOS version: ${Object.keys(data.platforms.ios.releases).pop()}`,
      );
    } else {
      console.error('Invalid iOS platform data');
    }
  })
  .catch((error) => console.error('Error fetching iOS data:', error));
```

## Development

### Lint/Validate JSON Data

Run the linting process to validate all JSON data files against their schemas:

```bash
pnpm run lint
```

### Build

The build process consists of two steps:

1. Generate TypeScript declarations for all JSON data files.
2. Generate platforms data.

```bash
pnpm run build
```

### Test

Run the test process to validate the generated TypeScript declarations:

```bash
pnpm run test
```
